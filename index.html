<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebAR Сканер</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>

    <style>
        #ar-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }
        #ar-start-button-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background: rgba(0,0,0,0.9); z-index: 200; pointer-events: auto; }
        a-scene { height: 100vh; width: 100vw; display: block; opacity: 0; transition: opacity 0.5s; }
        .interactive-ui { pointer-events: auto; }
        #direction-indicator { position: absolute; top: 50%; left: 50%; width: 60px; height: 60px; pointer-events: none; z-index: 150; }
    </style>
</head>
<body class="bg-gray-900 h-screen w-screen overflow-hidden">

    <div id="ar-overlay">
        <div class="p-4 flex justify-between items-start interactive-ui">
            <div id="score-display" class="bg-indigo-600 text-white font-bold text-xl px-4 py-2 rounded-lg shadow-lg">
                Очки: 0
            </div>
            <div id="message-box" class="bg-yellow-300 text-gray-800 font-medium px-4 py-2 rounded-lg shadow-lg max-w-xs text-sm">
                Нажмите начать...
            </div>
        </div>

        <div id="direction-indicator" style="display:none;">
            <svg viewBox="0 0 100 100" class="w-full h-full text-yellow-400 drop-shadow-lg">
                <path fill="currentColor" d="M 50 10 L 80 40 L 60 40 L 60 90 L 40 90 L 40 40 L 20 40 Z"/>
            </svg>
        </div>

        <div id="feedback-message" class="absolute inset-x-0 bottom-20 text-center interactive-ui"></div>
    </div>

    <div id="ar-start-button-overlay">
        <h1 class="text-white text-2xl font-bold mb-6">AR-поиск объектов</h1>
        <p class="text-gray-300 text-center mb-10 max-w-sm">Разрешите доступ к камере и гироскопу.</p>
        <button id="startButton" class="interactive-ui bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-8 rounded-full shadow-2xl transition duration-200 transform hover:scale-105">
            Начать AR-сессию
        </button>
    </div>

    <a-scene
        id="ar-scene"
        embedded
        vr-mode-ui="enabled: false"
        renderer="logarithmicDepthBuffer: true;"
        loading-screen="enabled: false;"
        direction-indicator>

        <a-box id="ar-object" position="0 0 -3" rotation="0 45 0" scale="0.5 0.5 0.5" color="#FF4500" material="opacity: 0.9; metalness: 0.5;" shadow></a-box>
        <a-entity camera></a-entity>
    </a-scene>

    <script>
        AFRAME.registerComponent('direction-indicator', {
            init: function () {
                this.camera = document.querySelector('a-entity[camera]').object3D;
                this.target = document.getElementById('ar-object').object3D;
                this.indicator = document.getElementById('direction-indicator');
                this.targetWorldPos = new THREE.Vector3();
                this.cameraWorldPos = new THREE.Vector3();
                this.vectorToTarget = new THREE.Vector3();
            },
            tick: function () {
                const targetEl = document.getElementById('ar-object');
                if (!targetEl.getAttribute('visible')) {
                    this.indicator.style.display = 'none';
                    return;
                }
                this.target.getWorldPosition(this.targetWorldPos);
                this.camera.getWorldPosition(this.cameraWorldPos);
                this.vectorToTarget.subVectors(this.targetWorldPos, this.cameraWorldPos);
                const targetAngleRad = Math.atan2(this.vectorToTarget.x, this.vectorToTarget.z);
                const cameraYRotationRad = this.camera.rotation.y;
                let angleDiffRad = targetAngleRad - cameraYRotationRad;
                while (angleDiffRad > Math.PI) angleDiffRad -= 2 * Math.PI;
                while (angleDiffRad < -Math.PI) angleDiffRad += 2 * Math.PI;
                const angleDiffDeg = angleDiffRad * (180 / Math.PI);
                const threshold = 15;
                if (Math.abs(angleDiffDeg) < threshold) {
                    this.indicator.style.display = 'none';
                } else {
                    this.indicator.style.display = 'block';
                    this.indicator.style.transform = `translate(-50%, -50%) rotate(${-angleDiffDeg}deg)`;
                }
            }
        });

        const scoreDisplay = document.getElementById('score-display');
        const messageBox = document.getElementById('message-box');
        const feedbackMessage = document.getElementById('feedback-message');
        const arObject = document.getElementById('ar-object');
        const startButtonOverlay = document.getElementById('ar-start-button-overlay');
        const arScene = document.getElementById('ar-scene');

        let score = 0;

        function updateScore(points) {
            score += points;
            scoreDisplay.textContent = `Очки: ${score}`;
            showFeedback(`+${points} Очко!`, 'bg-green-500');
        }

        function showFeedback(text, bgColor) {
            feedbackMessage.innerHTML = `<div class="${bgColor} text-white font-bold px-6 py-3 rounded-full shadow-xl animate-pulse text-lg">${text}</div>`;
            setTimeout(() => feedbackMessage.innerHTML = '', 1500);
        }

        function relocateObject() {
            const x = (Math.random() * 6) - 3;
            const y = (Math.random() * 6) - 3;
            const z = (Math.random() * -3) - 4;
            arObject.setAttribute('position', `${x.toFixed(2)} ${y.toFixed(2)} ${z.toFixed(2)}`);
            messageBox.textContent = 'Объект переместился! Ищите.';
            messageBox.classList.remove('bg-green-400', 'bg-red-600'); messageBox.classList.add('bg-purple-400');
        }

        arObject.addEventListener('click', () => {
            if (arObject.getAttribute('data-scored') === 'true') return;
            arObject.setAttribute('data-scored', 'true');
            updateScore(10);
            arObject.setAttribute('visible', false);
            setTimeout(() => {
                relocateObject();
                arObject.setAttribute('data-scored', 'false');
                arObject.setAttribute('visible', true);
                showFeedback('Новый объект!', 'bg-blue-500');
            }, 3000);
        });

        document.getElementById('startButton').addEventListener('click', async () => {
            startButtonOverlay.style.display = 'none';
            messageBox.textContent = 'Запуск...';

            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            if (isIOS && typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });

                // Динамически добавляем AR.js атрибуты после получения потока
                arScene.setAttribute('arjs', 'trackingMethod: best; sourceType: webcam; debugUIEnabled: false;');
                arScene.components.arjs.startSession(stream);

                setTimeout(() => {
                    arScene.style.opacity = '1';
                    window.dispatchEvent(new Event('resize'));
                    relocateObject();
                    messageBox.textContent = 'Объект загружен! Посмотрите вокруг.';
                    messageBox.classList.add('bg-green-400');
                }, 500);
            } catch (err) {
                handleError(err);
            }
            }

            // Добавляем AR.js атрибуты динамически
            arScene.setAttribute('arjs', `
                trackingMethod: best;
                sourceType: webcam;
                debugUIEnabled: false;
                detectionMode: mono;
            `);

            // Ждём инициализации AR.js
            arScene.addEventListener('arjs-video-loaded', () => {
                setTimeout(() => {
                    arScene.style.opacity = '1';
                    relocateObject();
                    messageBox.textContent = 'Найдите объект!';
                    messageBox.classList.add('bg-green-400');
                }, 300);
            }, { once: true });

            arScene.addEventListener('arjs-nft-no-video', () => {
                messageBox.textContent = 'Камера не работает';
                messageBox.classList.add('bg-red-600');
            }, { once: true });
        });
    </script>
</body>
</html>
